immich:
  # Define hostname anchor at the top
  shared_config:
    hostname: &hostname immich.le-g.dev
    url: &url https://immich.le-g.dev

  # Pass DB config to subchart (accessible as .Values.db in subchart context)
  db:
    username: immich
    database: immich
    hostname: "{{ .Release.Name }}-postgresql"
    passwordSecret:
      name: immich-postgresql-secret
      key: postgres-password

  controllers:
    main:
      containers:
        main:
          env:
            REDIS_HOSTNAME: "{{ .Release.Name }}-redis-master"
            DB_HOSTNAME: "{{ .Release.Name }}-postgresql"
            DB_USERNAME: "{{ .Values.db.username }}"
            DB_DATABASE_NAME: "{{ .Values.db.database }}"
            DB_PASSWORD:
              valueFrom:
                secretKeyRef:
                  name: "{{ .Values.db.passwordSecret.name }}"
                  key: "{{ .Values.db.passwordSecret.key }}"
            IMMICH_MACHINE_LEARNING_URL: '{{ printf "http://%s-machine-learning:3003" .Release.Name }}'

  immich:
    metrics:
      # Enabling this will create the service monitors needed to monitor immich with the prometheus operator
      enabled: false
    persistence:
      # Main data store for all phAotos shared between different components.
      library:
        # Automatically creating the library volume is not supported by this chart
        # You have to specify an existing PVC to use
        existingClaim: immich-nas-pvc
    # configuration is immich-config.json converted to yaml
    # ref: https://immich.app/docs/install/config-file/

  # Pin to v1.132.3 for intermediate upgrade path (required before upgrading to v2.0.0+)
  server:
    # Configure persistence mounts for the server component
    # Mount subdirectories to /usr/src/app/ where Immich expects them
    # encoded-video is a subdirectory of upload, so it will be accessible via /usr/src/app/upload/encoded-video/
    persistence:
      data:
        globalMounts:
          - path: /usr/src/app/upload
            subPath: upload
            readOnly: false
          - path: /usr/src/app/library
            subPath: library
            readOnly: false
          - path: /usr/src/app/profile
            subPath: profile
            readOnly: false
          - path: /usr/src/app/thumbs
            subPath: thumbs
            readOnly: false
    controllers:
      main:
        containers:
          main:
            image:
              tag: v1.132.3
    ingress:
      main:
        enabled: true
        ingressClassName: nginx
        annotations:
          cert-manager.io/cluster-issuer: letsencrypt-prod
          external-dns.alpha.kubernetes.io/target: homelab-tunnel.le-g.dev
          external-dns.alpha.kubernetes.io/cloudflare-proxied: 'true'
          nginx.ingress.kubernetes.io/proxy-body-size: "0"
          nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
          nginx.ingress.kubernetes.io/proxy-send-timeout: "600"
          nginx.ingress.kubernetes.io/ssl-redirect: "true"
        hosts:
          - host: *hostname
            paths:
              - path: "/"
        tls:
          - secretName: immich-ingress-tls
            hosts:
              - *hostname
  machine-learning:
    controllers:
      main:
        containers:
          main:
            image:
              tag: v1.132.3
postgresql:
  global:
    postgresql:
      auth:
        username: immich
        database: immich
        existingSecret: immich-postgresql-secret
        secretKeys:
          adminPasswordKey: postgres-password
          userPasswordKey: postgres-password
    security:
      allowInsecureImages: true
  image:
    registry: ghcr.io
    repository: le-g/homelab/pg
    tag: 16
    pullPolicy: Always
  postgresqlSharedPreloadLibraries: 'pgaudit,vectors'
  primary:
    initdb:
      scripts:
        enable-vector.sql: |
          -- This script runs as postgres superuser during database initialization
          CREATE EXTENSION IF NOT EXISTS vectors;
          -- Grant superuser privileges to immich user so it can create any extension
          ALTER USER immich WITH SUPERUSER;

redis:
  enabled: true
  architecture: standalone
  auth:
    enabled: false



